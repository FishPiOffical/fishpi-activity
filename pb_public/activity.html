<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê¥ªÂä®ËØ¶ÊÉÖ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Umami Analytics -->
    <script defer src="https://umami.aweoo.com/script.js" data-website-id="026abece-76c0-4781-8422-5e0b70b5a3b3"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans" x-data="activityPage()" x-cloak>

    <!-- View Full Page Button (Iframe Mode) -->
    <a x-show="isIframe" :href="fullPageUrl" target="_blank" class="fixed top-2 right-2 bg-white text-gray-600 hover:text-blue-600 px-3 py-1.5 rounded-full shadow-md text-xs font-medium z-50 flex items-center gap-1 border border-gray-200 transition-colors">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
        Êü•ÁúãÂÆåÊï¥È°µÈù¢
    </a>

    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-50" x-show="!isIframe">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="/" class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <span>üêü</span> FishPi Activity
            </a>
            <div class="space-x-4 hidden md:flex">
                <a href="#intro" class="text-gray-600 hover:text-gray-900">Ê¥ªÂä®‰ªãÁªç</a>
                <a href="#rewards" class="text-gray-600 hover:text-gray-900" x-show="rewards.length > 0">Â•ñÂä±‰ø°ÊÅØ</a>
                <a href="#articles" class="text-gray-600 hover:text-gray-900">ÊñáÁ´†ÂàóË°®</a>
                <a href="#history" class="text-gray-600 hover:text-gray-900" x-show="history.length > 0">ÂéÜÂè≤ÂõûÈ°æ</a>
            </div>
             <div class="space-x-4 md:hidden">
                <a href="/" class="text-gray-600 hover:text-gray-900">È¶ñÈ°µ</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 space-y-8 max-w-6xl">

        <!-- Loading State -->
        <div x-show="loading" class="flex justify-center items-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        </div>

        <!-- Error State -->
        <div x-show="error" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow" role="alert">
            <p class="font-bold">ÈîôËØØ</p>
            <p x-text="error"></p>
            <a href="/" class="mt-2 inline-block text-sm underline">ËøîÂõûÈ¶ñÈ°µ</a>
        </div>

        <div x-show="!loading && !error" class="space-y-8">

            <!-- Activity Introduction -->
            <section id="intro" class="bg-white rounded-xl shadow-sm overflow-hidden" x-show="!isIframe">
                <div class="p-6 md:p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div class="flex gap-2">
                             <span class="px-3 py-1 rounded-full text-sm font-medium"
                                   :class="getStatusClass(activity)"
                                   x-text="getStatusText(activity)">
                             </span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 text-gray-600 bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span class="font-semibold">ÂºÄÂßãÊó∂Èó¥:</span>
                            <span x-text="formatDate(activity.start)"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span class="font-semibold">ÁªìÊùüÊó∂Èó¥:</span>
                            <span x-text="formatDate(activity.end)"></span>
                        </div>
                    </div>

                    <div class="prose max-w-none text-gray-700 leading-relaxed" x-html="activity.desc"></div>

                    <div class="mt-6 pt-6 border-t border-gray-100" x-show="activity.articleUrl">
                        <a :href="activity.articleUrl" target="_blank" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium transition-colors">
                            <span>üìñ Êü•ÁúãÊ¥ªÂä®Êé®Êñá</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </a>
                    </div>
                </div>
            </section>

            <!-- Reward Information -->
            <section id="rewards" class="bg-white rounded-xl shadow-sm p-6 md:p-8" x-show="rewards.length > 0">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <span>üèÜ</span> Â•ñÂä±‰ø°ÊÅØ
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂêçÁß∞</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÊéíÂêçË¶ÅÊ±Ç</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-show="rewards.some(r => r.point > 0)">ÁßØÂàÜ</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂæΩÁ´†</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="reward in rewards" :key="reward.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                        <div x-text="reward.name"></div>
                                        <div class="text-xs text-gray-500 mt-1" x-show="reward.more" x-text="reward.more"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span x-show="reward.max === 0">ÂèÇ‰∏éÂ•ñÂä±</span>
                                        <span x-show="reward.max !== 0 && reward.min === reward.max" x-text="reward.min"></span>
                                        <span x-show="reward.max !== 0 && reward.min !== reward.max" x-text="reward.min + ' - ' + reward.max"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-show="rewards.some(r => r.point > 0)">
                                        <span class="font-bold text-orange-500" x-text="reward.point"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <div class="flex gap-2">
                                            <template x-for="shield in reward.expand?.shieldIds" :key="shield.id">
                                                <img :src="getBadgeUrl(shield)" alt="ÂæΩÁ´†" class="h-8" referrerpolicy="no-referrer" :title="shield.name">
                                            </template>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Article List -->
            <section id="articles" class="bg-white rounded-xl shadow-sm p-6 md:p-8">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <span>üìù</span> ÊñáÁ´†ÂàóË°®
                        <span class="text-sm font-normal text-gray-500 ml-2" x-text="'(' + articles.length + ')'"></span>
                    </h2>
                    <div class="flex items-center gap-3 bg-gray-50 p-2 rounded-lg">
                        <span class="text-sm text-gray-500">ÊéíÂ∫è:</span>
                        <select x-model="sortBy" @change="sortArticles()" class="bg-white border-gray-300 text-sm rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="createdAt">ÊúÄÊñ∞ÂèëÂ∏É</option>
                            <option value="viewCount">ÊµèËßàÈáè</option>
                            <option value="goodCnt">ÁÇπËµûÊï∞</option>
                            <option value="commentCount">ËØÑËÆ∫Êï∞</option>
                            <option value="collectCnt">Êî∂ËóèÊï∞</option>
                        </select>
                        <button @click="toggleSortOrder()" class="p-2 hover:bg-gray-200 rounded-md transition-colors" :title="sortDesc ? 'ÈôçÂ∫è' : 'ÂçáÂ∫è'">
                            <span x-text="sortDesc ? '‚Üì' : '‚Üë'" class="font-bold text-gray-700"></span>
                        </button>
                    </div>
                </div>

                <!-- Table View (Full Mode) -->
                <div x-show="!isIframe" class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">Ê†áÈ¢ò</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‰ΩúËÄÖ</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-blue-600" @click="setSort('viewCount')">ÊµèËßà</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-blue-600" @click="setSort('goodCnt')">ÁÇπËµû</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-blue-600" @click="setSort('commentCount')">ËØÑËÆ∫</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="article in articles" :key="article.id">
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4">
                                        <a :href="'https://fishpi.cn/article/' + article.oId" target="_blank" class="text-gray-900 font-medium hover:text-blue-600 hover:underline block truncate max-w-md" x-text="article.title"></a>
                                        <div class="text-xs text-gray-500 mt-1" x-text="formatDate(article.createdAt || article.created)"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                        <a :href="'https://fishpi.cn/member/' + (article.expand?.userId?.name || 'admin')" target="_blank" class="hover:text-blue-600 hover:underline" x-text="article.expand?.userId?.nickname || article.expand?.userId?.name || 'Êú™Áü•Áî®Êà∑'"></a>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right font-mono" x-text="article.viewCount"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right font-mono" x-text="article.goodCnt"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right font-mono" x-text="article.commentCount"></td>
                                </tr>
                            </template>
                            <tr x-show="articles.length === 0">
                                <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                    ÊöÇÊó†ÊñáÁ´†Êï∞ÊçÆ
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- List View (Iframe Mode) -->
                <div x-show="isIframe" class="space-y-3">
                    <template x-for="article in articles" :key="article.id">
                        <div class="bg-white p-3 rounded-lg border border-gray-200 hover:shadow-sm transition-shadow">
                            <div class="flex justify-between items-start gap-2">
                                <a :href="'https://fishpi.cn/article/' + article.oId" target="_blank" class="text-gray-900 font-medium hover:text-blue-600 line-clamp-2 text-sm flex-1" x-text="article.title"></a>
                                <span class="text-xs text-gray-400 whitespace-nowrap" x-text="formatDate(article.createdAt || article.created).split(' ')[0]"></span>
                            </div>
                            <div class="mt-2 flex justify-between items-center text-xs text-gray-500">
                                <a :href="'https://fishpi.cn/member/' + (article.expand?.userId?.name || 'admin')" target="_blank" class="hover:text-blue-600 flex items-center gap-1">
                                    <span x-text="article.expand?.userId?.nickname || article.expand?.userId?.name || 'Êú™Áü•Áî®Êà∑'"></span>
                                </a>
                                <div class="flex gap-3">
                                    <span class="flex items-center gap-0.5" title="ÊµèËßà"><span class="text-[10px]">üëÅÔ∏è</span> <span x-text="article.viewCount"></span></span>
                                    <span class="flex items-center gap-0.5" title="ÁÇπËµû"><span class="text-[10px]">üëç</span> <span x-text="article.goodCnt"></span></span>
                                    <span class="flex items-center gap-0.5" title="ËØÑËÆ∫"><span class="text-[10px]">üí¨</span> <span x-text="article.commentCount"></span></span>
                                </div>
                            </div>
                        </div>
                    </template>
                    <div x-show="articles.length === 0" class="text-center py-8 text-gray-500 text-sm">
                        ÊöÇÊó†ÊñáÁ´†Êï∞ÊçÆ
                    </div>
                </div>
            </section>

            <!-- History Review -->
            <section id="history" class="bg-white rounded-xl shadow-sm p-6 md:p-8" x-show="history.length > 0">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <span>üìú</span> ÂéÜÂè≤ÂõûÈ°æ
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <template x-for="item in history" :key="item.id">
                        <div class="bg-gray-50 rounded-lg p-6 hover:shadow-md transition-all border border-gray-100">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <div class="text-2xl font-bold text-gray-800" x-text="item.year + 'Âπ¥'"></div>
                                    <div class="text-sm text-gray-500 mt-1" x-show="item.start && item.end">
                                        <span x-text="formatDateOnly(item.start)"></span> - <span x-text="formatDateOnly(item.end)"></span>
                                    </div>
                                </div>
                                <div class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium" x-text="item.keyword"></div>
                            </div>

                            <div class="flex flex-wrap gap-4 mb-4">
                                <template x-if="item.expand?.articleShieldId">
                                    <div class="flex flex-col items-center gap-1">
                                        <span class="text-xs text-gray-500">Âπ¥ÁªàÂæÅÊñá</span>
                                        <img :src="getBadgeUrl(item.expand.articleShieldId)" alt="Âπ¥ÁªàÂæÅÊñáÂæΩÁ´†" class="h-8" referrerpolicy="no-referrer">
                                    </div>
                                </template>
                                <template x-if="item.expand?.ageShieldId">
                                    <div class="flex flex-col items-center gap-1">
                                        <span class="text-xs text-gray-500">Âπ¥‰ªΩÂæΩÁ´†</span>
                                        <img :src="getBadgeUrl(item.expand.ageShieldId)" alt="Âπ¥‰ªΩÂæΩÁ´†" class="h-8" referrerpolicy="no-referrer">
                                    </div>
                                </template>
                            </div>

                            <div class="flex gap-3 text-sm pt-4 border-t border-gray-200">
                                <a x-show="item.articleUrl" :href="item.articleUrl" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1">
                                    <span>üìñ Ê¥ªÂä®Êé®Êñá</span>
                                </a>
                                <a x-show="item.postArticleUrl" :href="item.postArticleUrl" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1">
                                    <span>üìä Ê±áÊÄªÈìæÊé•</span>
                                </a>
                            </div>
                        </div>
                    </template>
                </div>
            </section>
        </div>
    </div>

    <script>
        function activityPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            return {
                loading: true,
                error: null,
                activity: {},
                rewards: [],
                articles: [],
                history: [],
                sortBy: 'createdAt',
                sortDesc: true,
                isIframe: urlParams.get('type') === 'iframe' || window.self !== window.top,
                fullPageUrl: `${window.location.origin}${window.location.pathname}?id=${id}`,

                async init() {
                    if (!id) {
                        this.error = 'Êú™ÊåáÂÆöÊ¥ªÂä®ID';
                        this.loading = false;
                        return;
                    }

                    try {
                        // Fetch Activity
                        const activityRes = await fetch(`/api/collections/activities/records/${id}`);
                        if (!activityRes.ok) throw new Error('Ëé∑ÂèñÊ¥ªÂä®‰ø°ÊÅØÂ§±Ë¥•');
                        this.activity = await activityRes.json();

                        // Set document title
                        document.title = this.activity.name;

                        // Fetch Rewards
                        if (!this.isIframe && this.activity.rewardGroupId) {
                            const rewardsRes = await fetch(`/api/collections/rewards/records?filter=(rewardGroupId='${this.activity.rewardGroupId}')&sort=min&expand=shieldIds`);
                            if (rewardsRes.ok) {
                                const rewardsData = await rewardsRes.json();
                                this.rewards = rewardsData.items;
                            }
                        }

                        // Fetch Articles
                        // Try to expand userId to get user details
                        const articlesRes = await fetch(`/api/collections/relArticles/records?filter=(activityId='${id}')&sort=-createdAt&perPage=500&expand=userId`);
                        if (articlesRes.ok) {
                            const articlesData = await articlesRes.json();
                            this.articles = articlesData.items;
                            // Initial sort is already done by API (-createdAt), but we set local state to match
                            this.sortBy = 'createdAt';
                            this.sortDesc = true;
                        }

                        // Fetch History
                        if (!this.isIframe) {
                            const historyRes = await fetch(`/api/collections/yearlyHistories/records?sort=-year&expand=articleShieldId,ageShieldId`);
                            if (historyRes.ok) {
                                const historyData = await historyRes.json();
                                this.history = historyData.items;
                            }
                        }

                    } catch (e) {
                        console.error(e);
                        this.error = e.message || 'Âä†ËΩΩÊï∞ÊçÆÊó∂ÂèëÁîüÈîôËØØ';
                    } finally {
                        this.loading = false;
                    }
                },

                formatDate(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return date.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                },

                formatDateOnly(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return date.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
                },

                getBadgeUrl(shield) {
                    if (!shield) return '';
                    let shieldUrl = `https://badge.aweoo.com/gen?ver=${shield.ver || '0.1'}&scale=${shield.scale || '0.79'}&txt=${encodeURIComponent(shield.text || '')}&backcolor=${shield.backcolor || ''}&fontcolor=${shield.fontcolor || ''}`;
                    if (shield.url) {
                        shieldUrl += `&url=${encodeURIComponent(shield.url)}`;
                    }
                    // Optional params
                    const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
                    optionalParams.forEach(param => {
                        if (shield[param] !== undefined && shield[param] !== '') {
                            shieldUrl += `&${param}=${shield[param]}`;
                        }
                    });
                    return shieldUrl;
                },

                getStatusText(activity) {
                    const now = new Date();
                    const start = new Date(activity.start);
                    const end = new Date(activity.end);

                    if (now < start) return 'Âç≥Â∞ÜÂºÄÂßã';
                    if (now > end) return 'Â∑≤ÁªìÊùü';
                    return 'ËøõË°å‰∏≠';
                },

                getStatusClass(activity) {
                    const now = new Date();
                    const start = new Date(activity.start);
                    const end = new Date(activity.end);

                    if (now < start) return 'bg-blue-100 text-blue-800';
                    if (now > end) return 'bg-gray-100 text-gray-800';
                    return 'bg-green-100 text-green-800';
                },

                setSort(field) {
                    if (this.sortBy === field) {
                        this.sortDesc = !this.sortDesc;
                    } else {
                        this.sortBy = field;
                        this.sortDesc = false;
                    }
                    this.sortArticles();
                },

                toggleSortOrder() {
                    this.sortDesc = !this.sortDesc;
                    this.sortArticles();
                },

                sortArticles() {
                    const key = this.sortBy;
                    const desc = this.sortDesc ? -1 : 1;
                    this.articles.sort((a, b) => {
                        if (a[key] < b[key]) return -desc;
                        if (a[key] > b[key]) return desc;
                        return 0;
                    });
                },
            }
        }

        document.addEventListener('alpine:init', () => {
            Alpine.data('activityPage', activityPage);
        });
    </script>
</body>
</html>

