<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>æ‘¸é±¼æ´¾äº”å‘¨å¹´åº†å…¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        header h1 {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 10px;
        }

        header p {
            color: #666;
            font-size: 1.1rem;
        }

        .user-info {
            text-align: right;
            margin-bottom: 20px;
            color: white;
        }

        .user-info a {
            color: white;
            text-decoration: none;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin-left: 10px;
            transition: background 0.3s;
        }

        .user-info a:hover {
            background: rgba(255,255,255,0.3);
        }

        .login-prompt {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .activity-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .activity-section h2 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .activity-section p {
            color: #666;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input[type="color"] {
            height: 50px;
            cursor: pointer;
        }

        .color-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .shield-preview {
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            text-align: center;
        }

        .shield-preview img {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
        }

        .shield-url {
            background: white;
            padding: 10px;
            border-radius: 6px;
            word-break: break-all;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
            margin-right: 10px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .vote-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }

        .vote-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .vote-item {
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .vote-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102,126,234,0.2);
        }

        .vote-item.voted {
            border-color: #4CAF50;
            background: #f1f8f4;
        }

        .vote-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .vote-item-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .vote-item-name {
            font-weight: 600;
            color: #333;
        }

        .vote-item-content {
            margin: 10px 0;
            color: #666;
        }

        .vote-item-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .vote-count {
            color: #667eea;
            font-weight: 600;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .color-input-group {
                grid-template-columns: 1fr;
            }

            .vote-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="user-info" id="userInfo">
            <span id="userDisplay">åŠ è½½ä¸­...</span>
        </div>

        <header>
            <h1>ğŸ‰ æ‘¸é±¼æ´¾äº”å‘¨å¹´åº†å…¸</h1>
            <p>æ„Ÿè°¢é™ªä¼´ï¼Œè®©æˆ‘ä»¬ä¸€èµ·åº†ç¥æ‘¸é±¼æ´¾äº”å‘¨å²ç”Ÿæ—¥ï¼</p>
        </header>

        <div id="loginPrompt" class="login-prompt" style="display: none;">
            <p>ğŸ’¡ è¯·å…ˆç™»å½•åå‚ä¸æ´»åŠ¨è®¾è®¡å’ŒæŠ•ç¥¨ï¼Œæœªç™»å½•ç”¨æˆ·å¯ä»¥æŸ¥çœ‹æŠ•ç¥¨ç»“æœ</p>
            <a href="/fishpi/login" class="btn">ç«‹å³ç™»å½•</a>
        </div>

        <!-- æ´»åŠ¨ä¸€ï¼šäº”å‘¨å¹´å…³é”®è¯ -->
        <div class="activity-section" id="activity1">
            <h2>ğŸ“ æ´»åŠ¨ä¸€ï¼šäº”å‘¨å¹´å…³é”®è¯</h2>
            <p>ç”¨ä¸€ä¸ªå…³é”®è¯å®šä¹‰æ‘¸é±¼æ´¾çš„è¿™äº”å¹´ï¼å‘è¡¨æ–‡ç« ï¼Œæ ‡é¢˜ä¸ºæ‚¨çš„å…³é”®è¯ï¼Œå†…å®¹ä¸ºå…³é”®è¯ä»‹ç»ã€‚</p>

            <div id="activity1Form" style="display: none;">
                <div class="form-group">
                    <label for="keyword">å…³é”®è¯</label>
                    <input type="text" id="keyword" placeholder="è¯·è¾“å…¥ä¸€ä¸ªèƒ½ä»£è¡¨æ‘¸é±¼æ´¾äº”å¹´çš„å…³é”®è¯" maxlength="50">
                </div>
                <div class="form-group">
                    <label for="keywordDesc">å…³é”®è¯ä»‹ç»</label>
                    <textarea id="keywordDesc" placeholder="è¯·ä»‹ç»è¿™ä¸ªå…³é”®è¯çš„å«ä¹‰ä»¥åŠä¸ºä»€ä¹ˆé€‰æ‹©å®ƒ..."></textarea>
                </div>
                <button class="btn" onclick="submitKeyword()">æäº¤å…³é”®è¯</button>
            </div>

            <div class="vote-section">
                <h3>æŠ•ç¥¨ä¸æŸ¥çœ‹</h3>
                <div id="activity1Votes" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- æ´»åŠ¨äºŒï¼š2025æµè¡Œè‰² -->
        <div class="activity-section" id="activity2">
            <h2>ğŸ¨ æ´»åŠ¨äºŒï¼š2025æµè¡Œè‰²</h2>
            <p>ä¸º"2025å¾½ç« "è®¾è®¡æ‚¨å¿ƒç›®ä¸­çš„æµè¡Œé…è‰²æ–¹æ¡ˆï¼</p>

            <div id="activity2Form" style="display: none;">
                <div class="form-group">
                    <label for="badge2025Title">è®¾è®¡æ ‡é¢˜</label>
                    <input type="text" id="badge2025Title" placeholder="ç»™æ‚¨çš„é…è‰²æ–¹æ¡ˆèµ·ä¸ªåå­—" maxlength="50">
                </div>

                <div class="form-group">
                    <label for="badge2025Note">è®¾è®¡æ€è·¯</label>
                    <textarea id="badge2025Note" placeholder="ä»‹ç»ä¸€ä¸‹æ‚¨çš„è®¾è®¡æ€è·¯å’Œé…è‰²ç†å¿µ..." rows="3"></textarea>
                </div>

                <div class="color-input-group">
                    <div class="form-group">
                        <label for="badge2025Back">èƒŒæ™¯è‰²</label>
                        <input type="color" id="badge2025Back" value="#db5a6b">
                    </div>
                    <div class="form-group">
                        <label for="badge2025Font">å­—ä½“è‰²</label>
                        <input type="color" id="badge2025Font" value="#ffffff">
                    </div>
                </div>

                <div class="shield-preview">
                    <h4>å¾½ç« é¢„è§ˆ</h4>
                    <img id="badge2025Preview" src="" alt="å¾½ç« é¢„è§ˆ">
                    <div class="shield-url" id="badge2025Url"></div>
                </div>

                <button class="btn" onclick="submitBadge2025()">æäº¤é…è‰²æ–¹æ¡ˆ</button>
            </div>

            <div class="vote-section">
                <h3>æŠ•ç¥¨ä¸æŸ¥çœ‹</h3>
                <div id="activity2Votes" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- æ´»åŠ¨ä¸‰ï¼šäº”å‘¨å²å¾½ç«  -->
        <div class="activity-section" id="activity3">
            <h2>ğŸ† æ´»åŠ¨ä¸‰ï¼šäº”å‘¨å²å¾½ç« è®¾è®¡</h2>
            <p>è®¾è®¡"æ‘¸é±¼æ´¾5å²å•¦"ä¸“å±å¾½ç« ï¼é™¤äº†åç§°å›ºå®šå¤–ï¼Œå…¶ä»–å…ƒç´ éƒ½å¯ä»¥è‡ªç”±å®šåˆ¶ã€‚</p>

            <div id="activity3Form" style="display: none;">
                <div class="form-group">
                    <label for="badge5yTitle">è®¾è®¡æ ‡é¢˜</label>
                    <input type="text" id="badge5yTitle" placeholder="ç»™æ‚¨çš„å¾½ç« è®¾è®¡èµ·ä¸ªåå­—" maxlength="50">
                </div>

                <div class="form-group">
                    <label for="badge5yNote">è®¾è®¡æ€è·¯</label>
                    <textarea id="badge5yNote" placeholder="ä»‹ç»ä¸€ä¸‹æ‚¨çš„è®¾è®¡æ€è·¯..." rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="badge5yImageUpload">ä¸Šä¼ å¾½ç« å›¾ç‰‡</label>
                    <input type="file" id="badge5yImageUpload" accept="image/*" onchange="handleImageUpload(event)">
                    <small style="color: #666; display: block; margin-top: 5px;">æˆ–è€…è¾“å…¥å›¾ç‰‡URLï¼ˆé»˜è®¤ä½¿ç”¨æ‚¨çš„å¤´åƒï¼‰</small>
                </div>

                <div class="form-group">
                    <label for="badge5yUrl">å¾½ç« å›¾ç‰‡URL</label>
                    <input type="text" id="badge5yUrl" placeholder="é»˜è®¤ä½¿ç”¨æ‚¨çš„å¤´åƒ">
                </div>

                <div class="color-input-group">
                    <div class="form-group">
                        <label for="badge5yBack">èƒŒæ™¯è‰²</label>
                        <input type="color" id="badge5yBack" value="#db5a6b">
                    </div>
                    <div class="form-group">
                        <label for="badge5yFont">å­—ä½“è‰²</label>
                        <input type="color" id="badge5yFont" value="#ffffff">
                    </div>
                </div>

                <div class="form-group">
                    <label for="badge5ySize">å°ºå¯¸è°ƒæ•´ (å¯é€‰)</label>
                    <input type="number" id="badge5ySize" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼" min="1" max="1000">
                </div>

                <div class="form-group">
                    <label for="badge5yBorder">è¾¹æ¡†å®½åº¦ (å¯é€‰)</label>
                    <input type="number" id="badge5yBorder" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼" min="0" max="50">
                </div>

                <div class="form-group">
                    <label for="badge5yBarlen">æ¡å®½åº¦ (å¯é€‰)</label>
                    <input type="number" id="badge5yBarlen" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼" min="1" max="1000">
                </div>

                <div class="form-group">
                    <label for="badge5yFontsize">å­—ä½“å¤§å° (å¯é€‰)</label>
                    <input type="number" id="badge5yFontsize" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼" min="1" max="200">
                </div>

                <div class="form-group">
                    <label for="badge5yBarradius">åœ†è§’åŠå¾„ (å¯é€‰)</label>
                    <input type="number" id="badge5yBarradius" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼" min="0" max="100">
                </div>

                <div class="form-group">
                    <label for="badge5yShadow">é˜´å½±æ•ˆæœ (å¯é€‰)</label>
                    <select id="badge5yShadow">
                        <option value="">é»˜è®¤</option>
                        <option value="0">æ— é˜´å½±</option>
                        <option value="1">æœ‰é˜´å½±</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="badge5yAnime">åŠ¨ç”»æ•ˆæœ (å¯é€‰)</label>
                    <select id="badge5yAnime">
                        <option value="">é»˜è®¤</option>
                        <option value="0">æ— åŠ¨ç”»</option>
                        <option value="1">æœ‰åŠ¨ç”»</option>
                    </select>
                </div>

                <div class="shield-preview">
                    <h4>å¾½ç« é¢„è§ˆ</h4>
                    <img id="badge5yPreview" src="" alt="å¾½ç« é¢„è§ˆ">
                    <div class="shield-url" id="badge5yPreviewUrl"></div>
                </div>

                <button class="btn" onclick="submitBadge5Year()">æäº¤è®¾è®¡æ–¹æ¡ˆ</button>
            </div>

            <div class="vote-section">
                <h3>æŠ•ç¥¨ä¸æŸ¥çœ‹</h3>
                <div id="activity3Votes" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        const ACTIVITY_IDS = {
            main: '9sftj1vraueq7r5',
            keyword: '3uxf93bj633hgea',
            badge2025: 'iik1f2s5lut99l6',
            badge5year: '7on0ywnk5y1upj0'
        };

        let currentUser = null;
        let isLoggedIn = false;

        // åˆå§‹åŒ–
        async function init() {
            await checkLogin();
            setupEventListeners();
            loadAllVotes();
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLogin() {
            try {
                const response = await fetch('/user/me');
                if (response.ok) {
                    currentUser = await response.json();
                    isLoggedIn = true;
                    document.getElementById('userDisplay').innerHTML = `
                        <span>æ¬¢è¿ï¼Œ${escapeHtml(currentUser.nickname || currentUser.name)}</span>
                        <a href="/user/logout">é€€å‡ºç™»å½•</a>
                    `;
                    showForms();
                } else {
                    isLoggedIn = false;
                    document.getElementById('userDisplay').innerHTML = `
                        <a href="/fishpi/login">ç™»å½•</a>
                    `;
                    document.getElementById('loginPrompt').style.display = 'block';
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                isLoggedIn = false;
                document.getElementById('userDisplay').innerHTML = `
                    <a href="/fishpi/login">ç™»å½•</a>
                `;
                document.getElementById('loginPrompt').style.display = 'block';
            }
        }

        // æ˜¾ç¤ºè¡¨å•
        function showForms() {
            document.getElementById('activity1Form').style.display = 'block';
            document.getElementById('activity2Form').style.display = 'block';
            document.getElementById('activity3Form').style.display = 'block';

            // è®¾ç½®ç”¨æˆ·å¤´åƒä½œä¸ºé»˜è®¤å¾½ç« å›¾ç‰‡çš„å ä½ç¬¦
            if (currentUser && currentUser.avatar) {
                const urlInput = document.getElementById('badge5yUrl');
                if (!urlInput.value) {
                    urlInput.value = currentUser.avatar;
                    urlInput.placeholder = `é»˜è®¤ä½¿ç”¨æ‚¨çš„å¤´åƒ: ${currentUser.avatar}`;
                }
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ´»åŠ¨äºŒï¼š2025æµè¡Œè‰²é¢„è§ˆ
            document.getElementById('badge2025Back').addEventListener('input', updateBadge2025Preview);
            document.getElementById('badge2025Font').addEventListener('input', updateBadge2025Preview);

            // æ´»åŠ¨ä¸‰ï¼šäº”å‘¨å²å¾½ç« é¢„è§ˆ
            ['badge5yUrl', 'badge5yBack', 'badge5yFont', 'badge5ySize', 'badge5yBorder',
             'badge5yBarlen', 'badge5yFontsize', 'badge5yBarradius', 'badge5yShadow', 'badge5yAnime'].forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', updateBadge5YearPreview);
            });

            // åˆå§‹é¢„è§ˆ
            updateBadge2025Preview();
            updateBadge5YearPreview();
        }

        // æ›´æ–°2025å¾½ç« é¢„è§ˆ
        function updateBadge2025Preview() {
            const backcolor = document.getElementById('badge2025Back').value.substring(1);
            const fontcolor = document.getElementById('badge2025Font').value.substring(1);
            const defaultImage = 'https://file.fishpi.cn/2025/10/snake-d672120f.jpg';
            const url = `https://badge.aweoo.com/gen?ver=0.1&scale=0.79&txt=2025&url=${encodeURIComponent(defaultImage)}&backcolor=${backcolor}&fontcolor=${fontcolor}`;

            document.getElementById('badge2025Preview').src = url;
            document.getElementById('badge2025Url').textContent = url;
        }

        // æ›´æ–°äº”å‘¨å²å¾½ç« é¢„è§ˆ
        function updateBadge5YearPreview() {
            const txt = 'æ‘¸é±¼æ´¾5å²å•¦';
            let url = document.getElementById('badge5yUrl').value;

            // å¦‚æœæ²¡æœ‰è¾“å…¥URLï¼Œä½¿ç”¨ç”¨æˆ·å¤´åƒ
            if (!url && currentUser && currentUser.avatar) {
                url = currentUser.avatar;
            }

            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰URLï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡
            if (!url) {
                url = 'https://file.fishpi.cn/2022/02/å¥–ç‰Œ-d667b38a.jpg';
            }

            const backcolor = document.getElementById('badge5yBack').value.substring(1);
            const fontcolor = document.getElementById('badge5yFont').value.substring(1);

            let genUrl = `https://badge.aweoo.com/gen?ver=0.1&scale=0.79&txt=${encodeURIComponent(txt)}&url=${encodeURIComponent(url)}&backcolor=${backcolor}&fontcolor=${fontcolor}`;

            // æ·»åŠ å¯é€‰å‚æ•°
            const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
            optionalParams.forEach(param => {
                const inputId = 'badge5y' + param.charAt(0).toUpperCase() + param.slice(1);
                const value = document.getElementById(inputId).value;
                if (value !== '') {
                    genUrl += `&${param}=${value}`;
                }
            });

            document.getElementById('badge5yPreview').src = genUrl;
            document.getElementById('badge5yPreviewUrl').textContent = genUrl;
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶5MBï¼‰
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                return;
            }

            try {
                // åˆ›å»ºFormDataä¸Šä¼ æ–‡ä»¶
                const formData = new FormData();
                formData.append('file', file);

                // è¿™é‡Œéœ€è¦è°ƒç”¨æ‘¸é±¼æ´¾çš„æ–‡ä»¶ä¸Šä¼ API
                // æš‚æ—¶ä½¿ç”¨FileReaderè½¬æ¢ä¸ºbase64ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    // ç›´æ¥ä½¿ç”¨URLï¼ˆå®é™…åº”è¯¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰
                    alert('å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½éœ€è¦å¯¹æ¥æ‘¸é±¼æ´¾æ–‡ä»¶ä¸Šä¼ APIã€‚\nè¯·æ‰‹åŠ¨ä¸Šä¼ å›¾ç‰‡åå¡«å…¥URLã€‚');
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æäº¤å…³é”®ï¿½ï¿½
        async function submitKeyword() {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const keyword = document.getElementById('keyword').value.trim();
            const desc = document.getElementById('keywordDesc').value.trim();

            if (!keyword || !desc) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å…³é”®è¯å’Œä»‹ç»');
                return;
            }

            try {
                const response = await fetch('/activity-api/shield-five-year/articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        activityId: ACTIVITY_IDS.keyword,
                        title: keyword,
                        content: desc
                    })
                });

                if (response.ok) {
                    alert('å…³é”®è¯æäº¤æˆåŠŸï¼');
                    document.getElementById('keyword').value = '';
                    document.getElementById('keywordDesc').value = '';
                    loadArticles('keyword', 'activity1Votes');
                } else {
                    const error = await response.json();
                    alert(error.message || 'æäº¤å¤±è´¥');
                }
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æäº¤2025å¾½ç« é…è‰²
        async function submitBadge2025() {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const title = document.getElementById('badge2025Title').value.trim();
            const note = document.getElementById('badge2025Note').value.trim();
            const backcolor = document.getElementById('badge2025Back').value.substring(1);
            const fontcolor = document.getElementById('badge2025Font').value.substring(1);

            if (!title) {
                alert('è¯·å¡«å†™è®¾è®¡æ ‡é¢˜');
                return;
            }

            try {
                const defaultImage = 'https://file.fishpi.cn/2025/10/snake-d672120f.jpg';

                // ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºå¾½ç« 
                const shieldResponse = await fetch('/activity-api/shield-five-year/shields', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        activityId: ACTIVITY_IDS.badge2025,
                        text: '2025',
                        url: defaultImage,
                        backcolor: backcolor,
                        fontcolor: fontcolor,
                        ver: '0.1',
                        scale: '0.79',
                        title: title,
                        note: note
                    })
                });

                if (!shieldResponse.ok) {
                    const error = await shieldResponse.json();
                    alert(error.message || 'å¾½ç« ä¿å­˜å¤±è´¥');
                    return;
                }

                const shieldData = await shieldResponse.json();
                const shieldId = shieldData.shield?.id;

                // ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ–‡ç« å¹¶ç»‘å®šå¾½ç« 
                const articleResponse = await fetch('/activity-api/shield-five-year/articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        activityId: ACTIVITY_IDS.badge2025,
                        title: title,
                        content: note || 'æˆ‘çš„2025å¾½ç« é…è‰²è®¾è®¡',
                        shieldId: shieldId
                    })
                });

                if (articleResponse.ok) {
                    alert('2025å¾½ç« é…è‰²æäº¤æˆåŠŸï¼');
                    document.getElementById('badge2025Title').value = '';
                    document.getElementById('badge2025Note').value = '';
                    loadArticles('badge2025', 'activity2Votes');
                } else {
                    const error = await articleResponse.json();
                    alert(error.message || 'æ–‡ç« ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æäº¤äº”å‘¨å²å¾½ç« è®¾è®¡
        async function submitBadge5Year() {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const title = document.getElementById('badge5yTitle').value.trim();
            const note = document.getElementById('badge5yNote').value.trim();
            const text = 'æ‘¸é±¼æ´¾5å²å•¦';
            let url = document.getElementById('badge5yUrl').value;

            // å¦‚æœæ²¡æœ‰è¾“å…¥URLï¼Œä½¿ç”¨ç”¨æˆ·å¤´åƒ
            if (!url && currentUser && currentUser.avatar) {
                url = currentUser.avatar;
            }

            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰URLï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡
            if (!url) {
                url = 'https://file.fishpi.cn/2022/02/å¥–ç‰Œ-d667b38a.jpg';
            }

            const backcolor = document.getElementById('badge5yBack').value.substring(1);
            const fontcolor = document.getElementById('badge5yFont').value.substring(1);

            if (!title) {
                alert('è¯·å¡«å†™è®¾è®¡æ ‡é¢˜');
                return;
            }

            const shieldData = {
                activityId: ACTIVITY_IDS.badge5year,
                text: text,
                url: url,
                backcolor: backcolor,
                fontcolor: fontcolor,
                ver: '0.1',
                scale: '0.79',
                title: title,
                note: note
            };

            // æ·»åŠ å¯é€‰å‚æ•°
            const optionalParams = ['size', 'border', 'barlen', 'fontsize', 'barradius', 'shadow', 'anime'];
            optionalParams.forEach(param => {
                const inputId = 'badge5y' + param.charAt(0).toUpperCase() + param.slice(1);
                const value = document.getElementById(inputId).value;
                if (value !== '') {
                    shieldData[param] = value;
                }
            });

            try {
                const response = await fetch('/activity-api/shield-five-year/shields', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(shieldData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.message || 'å¾½ç« ä¿å­˜å¤±è´¥');
                    return;
                }

                const shieldResponse = await response.json();
                const shieldId = shieldResponse.shield?.id;

                // ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ–‡ç« å¹¶ç»‘å®šå¾½ç« 
                const articleResponse = await fetch('/activity-api/shield-five-year/articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        activityId: ACTIVITY_IDS.badge5year,
                        title: title,
                        content: note || 'æˆ‘çš„äº”å‘¨å²å¾½ç« è®¾è®¡',
                        shieldId: shieldId
                    })
                });

                if (articleResponse.ok) {
                    alert('äº”å‘¨å²å¾½ç« è®¾è®¡æäº¤æˆåŠŸï¼');
                    document.getElementById('badge5yTitle').value = '';
                    document.getElementById('badge5yNote').value = '';
                    loadArticles('badge5year', 'activity3Votes');
                } else {
                    const error = await articleResponse.json();
                    alert(error.message || 'æ–‡ç« ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åŠ è½½æ‰€æœ‰æŠ•ç¥¨
        async function loadAllVotes() {
            loadArticles('keyword', 'activity1Votes');
            loadArticles('badge2025', 'activity2Votes');
            loadArticles('badge5year', 'activity3Votes');
        }

        // åŠ è½½æ–‡ç« åˆ—è¡¨ï¼ˆå…³é”®è¯æ´»åŠ¨ï¼‰
        async function loadArticles(activityKey, containerId) {
            const activityId = ACTIVITY_IDS[activityKey];
            try {
                const [articlesRes, statsRes] = await Promise.all([
                    fetch(`/activity-api/shield-five-year/articles/${activityId}`),
                    fetch(`/activity-api/shield-five-year/vote-stats/${activityId}`)
                ]);

                if (!articlesRes.ok) {
                    throw new Error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥');
                }

                const articlesData = await articlesRes.json();
                const statsData = statsRes.ok ? await statsRes.json() : { stats: {} };

                renderArticles(articlesData.items || [], statsData.stats || {}, activityId, containerId);
            } catch (error) {
                console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
                document.getElementById(containerId).innerHTML = '<p class="error">åŠ è½½æ•°æ®å¤±è´¥</p>';
            }
        }

        // æ¸²æŸ“æ–‡ç« åˆ—è¡¨
        function renderArticles(articles, stats, activityId, containerId) {
            const container = document.getElementById(containerId);

            if (articles.length === 0) {
                container.innerHTML = '<p>æš‚æ— æŠ•ç¨¿</p>';
                return;
            }

            const html = articles.map(article => {
                const voteCount = stats[article.user?.id] || 0;
                const voted = false; // TODO: æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²æŠ•ç¥¨

                // å¦‚æœæ–‡ç« æœ‰å…³è”çš„å¾½ç« ï¼Œç”Ÿæˆå¾½ç« URL
                let shieldHtml = '';
                if (article.shield) {
                    const shield = article.shield;
                    const shieldUrl = `https://badge.aweoo.com/gen?ver=0.1&scale=0.79&txt=${encodeURIComponent(shield.text || '')}&backcolor=${shield.backcolor || ''}&fontcolor=${shield.fontcolor || ''}${shield.url ? '&url=' + encodeURIComponent(shield.url) : ''}`;
                    shieldHtml = `
                        <div style="margin: 10px 0;">
                            <img src="${shieldUrl}" alt="å¾½ç« " style="max-width: 100%;" referrerpolicy="no-referrer">
                        </div>
                    `;
                }

                return `
                    <div class="vote-item ${voted ? 'voted' : ''}">
                        <div class="vote-item-header">
                            <img src="${escapeHtml(article.user?.avatar || '')}"
                                 alt="avatar" class="vote-item-avatar"
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%23ddd%22/></svg>'">
                            <div class="vote-item-name">${escapeHtml(article.user?.nickname || article.user?.name || 'åŒ¿å')}</div>
                        </div>
                        <div class="vote-item-content">
                            <strong>${escapeHtml(article.title)}</strong>
                            ${shieldHtml}
                            <p>${escapeHtml(article.content).substring(0, 100)}...</p>
                        </div>
                        <div class="vote-item-actions">
                            <span class="vote-count">â¤ï¸ ${voteCount} ç¥¨</span>
                            ${isLoggedIn && article.user?.id !== currentUser?.id ?
                                `<button class="btn" onclick="voteFor('${activityId}', '${article.user?.id}')">æŠ•ç¥¨</button>` :
                                ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="vote-list">${html}</div>`;
        }

        // åŠ è½½å¾½ç« åˆ—è¡¨
        async function loadShields(activityKey, containerId) {
            const activityId = ACTIVITY_IDS[activityKey];
            try {
                const [shieldsRes, statsRes] = await Promise.all([
                    fetch(`/activity-api/shield-five-year/shields/${activityId}`),
                    fetch(`/activity-api/shield-five-year/vote-stats/${activityId}`)
                ]);

                if (!shieldsRes.ok) {
                    throw new Error('è·å–å¾½ç« åˆ—è¡¨å¤±è´¥');
                }

                const shieldsData = await shieldsRes.json();
                const statsData = statsRes.ok ? await statsRes.json() : { stats: {} };

                renderShields(shieldsData.items || [], statsData.stats || {}, activityId, containerId);
            } catch (error) {
                console.error('åŠ è½½å¾½ç« å¤±è´¥:', error);
                document.getElementById(containerId).innerHTML = '<p class="error">åŠ è½½æ•°æ®å¤±è´¥</p>';
            }
        }

        // æ¸²æŸ“å¾½ç« åˆ—è¡¨
        function renderShields(shields, stats, activityId, containerId) {
            const container = document.getElementById(containerId);

            if (shields.length === 0) {
                container.innerHTML = '<p>æš‚æ— æŠ•ç¨¿</p>';
                return;
            }

            const html = shields.map(shield => {
                const voteCount = stats[shield.user?.id] || 0;
                const voted = false; // TODO: æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²æŠ•ç¥¨

                const shieldUrl = `https://badge.aweoo.com/gen?ver=0.1&scale=0.79&txt=${encodeURIComponent(shield.text)}&backcolor=${shield.backcolor}&fontcolor=${shield.fontcolor}${shield.url ? '&url=' + encodeURIComponent(shield.url) : ''}`;

                return `
                    <div class="vote-item ${voted ? 'voted' : ''}">
                        <div class="vote-item-header">
                            <img src="${escapeHtml(shield.user?.avatar || '')}"
                                 alt="avatar" class="vote-item-avatar"
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22><rect width=%2240%22 height=%2240%22 fill=%22%23ddd%22/></svg>'">
                            <div class="vote-item-name">${escapeHtml(shield.user?.nickname || shield.user?.name || 'åŒ¿å')}</div>
                        </div>
                        <div class="vote-item-content">
                            ${shield.title ? `<h4 style="margin-bottom: 10px; color: #333;">${escapeHtml(shield.title)}</h4>` : ''}
                            <img src="${shieldUrl}" alt="å¾½ç« " style="max-width: 100%; margin: 10px 0;" referrerpolicy="no-referrer">
                            ${shield.note ? `<p style="margin-top: 10px; color: #666; font-size: 0.9rem;">${escapeHtml(shield.note)}</p>` : ''}
                        </div>
                        <div class="vote-item-actions">
                            <span class="vote-count">â¤ï¸ ${voteCount} ç¥¨</span>
                            ${isLoggedIn && shield.user?.id !== currentUser?.id ?
                                `<button class="btn" onclick="voteFor('${activityId}', '${shield.user?.id}')">æŠ•ç¥¨</button>` :
                                ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="vote-list">${html}</div>`;
        }

        // æŠ•ç¥¨
        async function voteFor(activityId, targetUserId) {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•åå†æŠ•ç¥¨');
                return;
            }

            try {

                const response = await fetch('/activity-api/shield-five-year/vote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        activityId: activityId, // ä¼ é€’activityIdè®©åç«¯æŸ¥æ‰¾voteId
                        toUserId: targetUserId
                    })
                });

                if (response.ok) {
                    alert('æŠ•ç¥¨æˆåŠŸï¼');
                    loadAllVotes();
                } else {
                    const error = await response.json();
                    alert(error.message || 'æŠ•ç¥¨å¤±è´¥');
                }
            } catch (error) {
                console.error('æŠ•ç¥¨å¤±è´¥:', error);
                alert('æŠ•ç¥¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
